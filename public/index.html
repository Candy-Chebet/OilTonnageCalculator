<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edible Oil Tonnage Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // API Configuration
        const API_BASE_URL = '/api';
        
        // State management
        let calculations = [];
        let filteredCalculations = [];
        let currentPage = 1;
        let totalPages = 1;
        let isLoading = false;

        // API Helper functions
        async function apiRequest(endpoint, options = {}) {
            console.log('üîÑ Making API request to:', `${API_BASE_URL}${endpoint}`);
            console.log('üîÑ Request options:', options);
            
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                console.log('üì° Response status:', response.status);
                console.log('üì° Response ok:', response.ok);
                
                const data = await response.json();
                console.log('üì¶ Response data:', data);
                
                if (!response.ok) {
                    throw new Error(data.message || data.error || 'Request failed');
                }
                
                return data;
            } catch (error) {
                console.error('‚ùå API Request failed:', error);
                throw error;
            }
        }

        function showLoading() {
            isLoading = true;
            document.getElementById('loadingSpinner').classList.remove('hidden');
        }

        function hideLoading() {
            isLoading = false;
            document.getElementById('loadingSpinner').classList.add('hidden');
        }

        function showError(message) {
            console.error('üö® Error:', message);
            const errorDiv = document.getElementById('errors');
            errorDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-2">${message}</div>`;
            setTimeout(() => {
                errorDiv.innerHTML = '';
            }, 5000);
        }

        function showSuccess(message) {
            console.log('‚úÖ Success:', message);
            const errorDiv = document.getElementById('errors');
            errorDiv.innerHTML = `<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-2">${message}</div>`;
            setTimeout(() => {
                errorDiv.innerHTML = '';
            }, 3000);
        }

        async function calculateTonnage() {
            if (isLoading) return;
            
            const volume = parseFloat(document.getElementById('volume').value);
            const density = parseFloat(document.getElementById('density').value);
            const temperature = parseFloat(document.getElementById('temperature').value);
            
            console.log('üßÆ Calculating tonnage with:', { volume, density, temperature });
            
            // Clear previous errors
            document.getElementById('errors').innerHTML = '';
            
            try {
                showLoading();
                
                const response = await apiRequest('/calculate', {
                    method: 'POST',
                    body: JSON.stringify({ volume, density, temperature })
                });
                
                const result = response.data;
                console.log('‚úÖ Calculation result:', result);
                
                // Display result
                document.getElementById('result').innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-green-800 mb-4">Calculation Result</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="font-medium text-gray-600">Volume:</span>
                                <span class="text-gray-800">${result.volume.toLocaleString()} L</span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-600">Density:</span>
                                <span class="text-gray-800">${result.density} kg/m¬≥</span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-600">Temperature:</span>
                                <span class="text-gray-800">${result.temperature}¬∞C</span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-600">VCF Used:</span>
                                <span class="text-gray-800">${result.vcf.toFixed(4)}</span>
                            </div>
                            <div class="col-span-2 pt-2 border-t border-green-200">
                                <span class="font-bold text-green-800 text-lg">Tonnage: ${result.tonnage.toFixed(6)} MT</span>
                            </div>
                            <div class="col-span-2 text-xs text-gray-500">
                                VCF retrieved using density: ${result.usedDensity} kg/m¬≥, temperature: ${result.usedTemp}¬∞C
                            </div>
                        </div>
                    </div>
                `;
                
                // Reset form
                document.getElementById('calculationForm').reset();
                
                // Reset to first page and refresh history
                currentPage = 1;
                await loadCalculations();
                
                showSuccess('Calculation completed and saved successfully!');
                
            } catch (error) {
                console.error('Calculation error:', error);
                if (error.message.includes('Validation failed')) {
                    showError('Please check your input values and try again.');
                } else {
                    showError(`Calculation failed: ${error.message}`);
                }
            } finally {
                hideLoading();
            }
        }

        async function loadCalculations() {
            console.log('üìã Loading calculations...');
            try {
                const searchTerm = document.getElementById('searchInput').value;
                const sortOrder = document.getElementById('sortSelect').value;
                
                const params = new URLSearchParams({
                    page: currentPage,
                    limit: 20,
                    search: searchTerm,
                    sort: 'created_at',
                    order: sortOrder
                });
                
                console.log('üìã Request params:', params.toString());
                
                const response = await apiRequest(`/calculations?${params}`);
                console.log('üìã Received response:', response);
                
                if (!response.success) {
                    throw new Error(response.message || 'Response indicates failure');
                }
                
                calculations = response.data || [];
                filteredCalculations = [...calculations];
                
                console.log('üìã Calculations loaded:', calculations.length);
                
                // Update pagination info
                if (response.pagination) {
                    totalPages = response.pagination.pages;
                    updatePaginationControls(response.pagination);
                    console.log('üìã Pagination:', response.pagination);
                } else {
                    console.warn('‚ö†Ô∏è No pagination info in response');
                }
                
                renderHistoryTable();
                
            } catch (error) {
                console.error('‚ùå Error loading calculations:', error);
                showError(`Failed to load calculation history: ${error.message}`);
                
                // Show empty table on error
                const tbody = document.getElementById('historyTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-red-500">
                            Error loading calculations: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        function renderHistoryTable() {
            console.log('üé® Rendering history table with', filteredCalculations.length, 'items');
            const tbody = document.getElementById('historyTableBody');
            
            if (filteredCalculations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                            No calculations found
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = filteredCalculations.map(calc => {
                console.log('üé® Rendering calculation:', calc);
                // Ensure we have a valid date
                const dateStr = calc.timestamp || calc.created_at;
                const displayDate = dateStr ? new Date(dateStr).toLocaleString() : 'N/A';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${displayDate}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${parseFloat(calc.volume).toLocaleString()}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${calc.density}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${calc.temperature}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${parseFloat(calc.vcf).toFixed(4)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${parseFloat(calc.tonnage).toFixed(6)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <button 
                                onclick="deleteCalculation(${calc.id})"
                                class="text-red-600 hover:text-red-900 transition duration-200"
                                title="Delete calculation"
                            >
                                Delete
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            console.log('üé® Table rendered successfully');
        }

        async function deleteCalculation(id) {
            if (!confirm('Are you sure you want to delete this calculation?')) return;
            
            try {
                await apiRequest(`/calculations/${id}`, { method: 'DELETE' });
                showSuccess('Calculation deleted successfully');
                await loadCalculations();
            } catch (error) {
                console.error('Error deleting calculation:', error);
                showError('Failed to delete calculation');
            }
        }

        async function clearAllCalculations() {
            if (!confirm('Are you sure you want to clear all calculation history? This action cannot be undone.')) return;
            
            try {
                await apiRequest('/calculations', { method: 'DELETE' });
                showSuccess('All calculations cleared successfully');
                currentPage = 1;
                await loadCalculations();
            } catch (error) {
                console.error('Error clearing calculations:', error);
                showError('Failed to clear calculations');
            }
        }

        function updatePaginationControls(pagination) {
            console.log('üìÑ Updating pagination:', pagination);
            const paginationDiv = document.getElementById('pagination');
            
            if (pagination.pages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            const prevDisabled = pagination.page <= 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100';
            const nextDisabled = pagination.page >= pagination.pages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100';
            
            paginationDiv.innerHTML = `
                <div class="flex items-center justify-between px-4 py-3 bg-white border-t border-gray-200">
                    <div class="flex-1 flex justify-between sm:hidden">
                        <button 
                            onclick="changePage(${pagination.page - 1})"
                            class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white ${prevDisabled}"
                            ${pagination.page <= 1 ? 'disabled' : ''}
                        >
                            Previous
                        </button>
                        <button 
                            onclick="changePage(${pagination.page + 1})"
                            class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white ${nextDisabled}"
                            ${pagination.page >= pagination.pages ? 'disabled' : ''}
                        >
                            Next
                        </button>
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                Showing page <span class="font-medium">${pagination.page}</span> of 
                                <span class="font-medium">${pagination.pages}</span>
                                (${pagination.total} total results)
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                                <button 
                                    onclick="changePage(${pagination.page - 1})"
                                    class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 ${prevDisabled}"
                                    ${pagination.page <= 1 ? 'disabled' : ''}
                                >
                                    Previous
                                </button>
                                <button 
                                    onclick="changePage(${pagination.page + 1})"
                                    class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 ${nextDisabled}"
                                    ${pagination.page >= pagination.pages ? 'disabled' : ''}
                                >
                                    Next
                                </button>
                            </nav>
                        </div>
                    </div>
                </div>
            `;
        }

        async function changePage(page) {
            if (page < 1 || page > totalPages || page === currentPage) return;
            currentPage = page;
            await loadCalculations();
        }

        // Search with debouncing
        let searchTimeout;
        function searchCalculations() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentPage = 1;
                loadCalculations();
            }, 500);
        }

        function sortCalculations() {
            currentPage = 1;
            loadCalculations();
        }

        // Initialize on page load
        window.onload = async function() {
            console.log('üöÄ Page loaded, initializing...');
            
            try {
                // Health check first
                console.log('üè• Performing health check...');
                const healthResponse = await apiRequest('/health');
                console.log('üè• Health check result:', healthResponse);
                
                if (healthResponse.success) {
                    showSuccess('Server connection successful!');
                } else {
                    showError('Server health check failed');
                }
            } catch (error) {
                console.error('üè• Health check failed:', error);
                showError(`Server connection failed: ${error.message}`);
            }
            
            // Load calculations
            await loadCalculations();
        };
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-4 rounded-lg flex items-center">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-3"></div>
            <span>Processing...</span>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">Edible Oil Tonnage Calculator</h1>
            
            <!-- Calculation Form -->
            <div class="grid md:grid-cols-2 gap-8">
                <div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-6">Calculate Tonnage</h2>
                    
                    <div id="errors" class="mb-4"></div>
                    
                    <form id="calculationForm" onsubmit="event.preventDefault(); calculateTonnage();" class="space-y-6">
                        <div>
                            <label for="volume" class="block text-sm font-medium text-gray-700 mb-2">
                                Volume (Litres) *
                            </label>
                            <input 
                                type="number" 
                                id="volume" 
                                step="0.01" 
                                min="0.01"
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Enter volume in litres"
                                required
                            >
                        </div>
                        
                        <div>
                            <label for="density" class="block text-sm font-medium text-gray-700 mb-2">
                                Density (kg/m¬≥) *
                            </label>
                            <input 
                                type="number" 
                                id="density" 
                                step="0.1" 
                                min="700" 
                                max="1000"
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Enter density (700-1000 kg/m¬≥)"
                                required
                            >
                        </div>
                        
                        <div>
                            <label for="temperature" class="block text-sm font-medium text-gray-700 mb-2">
                                Temperature (¬∞C) *
                            </label>
                            <input 
                                type="number" 
                                id="temperature" 
                                step="0.25" 
                                min="-20" 
                                max="60"
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Enter temperature (-20 to 60¬∞C)"
                                required
                            >
                        </div>
                        
                        <button 
                            type="submit"
                            class="w-full bg-blue-600 text-white py-3 px-6 rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            Calculate Tonnage
                        </button>
                    </form>
                </div>
                
                <div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-6">Result</h2>
                    <div id="result" class="min-h-[200px] flex items-center justify-center text-gray-500">
                        Results will appear here after calculation
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Historical Calculations -->
        <div class="bg-white rounded-lg shadow-lg p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-gray-700">Historical Calculations</h2>
                <button 
                    onclick="clearAllCalculations()"
                    class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition duration-200 text-sm"
                >
                    Clear All History
                </button>
            </div>
            
            <!-- Search and Sort Controls -->
            <div class="flex flex-wrap gap-4 mb-6">
                <div class="flex-1 min-w-[250px]">
                    <input 
                        type="text" 
                        id="searchInput"
                        placeholder="Search calculations..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        oninput="searchCalculations()"
                    >
                </div>
                <div>
                    <select 
                        id="sortSelect"
                        class="px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        onchange="sortCalculations()"
                    >
                        <option value="DESC">Newest First</option>
                        <option value="ASC">Oldest First</option>
                    </select>
                </div>
            </div>
            
            <!-- Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Date & Time
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Volume (L)
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Density (kg/m¬≥)
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Temperature (¬∞C)
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                VCF
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Tonnage (MT)
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div id="pagination"></div>
        </div>
        
        <!-- Footer Info -->
        <div class="mt-8 bg-blue-50 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-blue-800 mb-3">Formula Used</h3>
            <p class="text-blue-700 mb-2">
                <strong>Tonnage (MT) = (Volume √ó Density √ó VCF) √∑ 1,000,000</strong>
            </p>
            <p class="text-sm text-blue-600">
                Volume Correction Factor (VCF) is retrieved from a lookup table based on density (rounded to nearest 0.5 kg/m¬≥) 
                and temperature (rounded to nearest 0.25¬∞C).
            </p>
        </div>
    </div>
</body>
</html>